# `mrtrix_tune.py` (MRtrix backend tuner)

## Purpose
Runs a parameter sweep (`sweep`) or Bayesian optimization (`bayes`) for MRtrix tractography/connectome settings, producing OptiConn-style outputs under a safe output directory (never writes into `qsiprep/` or `qsirecon/`).

## Requirements
- Activated venv: `source braingraph_pipeline/bin/activate`
- MRtrix3 available on `PATH` (or installed via `./install.sh --mrtrix-install`)
- QSIRecon outputs for the subject (WM FOD + atlas dseg + labels; ACT tissue optional unless ACT is enabled)

## Usage
### 1) One-step discovery mode (recommended)
Provide a BIDS derivatives root (or explicit QSI folders) and let the script auto-discover the required bundle files:

```bash
python scripts/mrtrix_tune.py sweep \
  --derivatives-dir /path/to/derivatives \
  --subject sub-XXXX \
  --session ses-YY \
  --atlas Brainnetome246Ext \
  --output-dir /path/to/derivatives/opticonn/mrtrix_sweep \
  --run-name sweep_demo \
  --n-samples 3 \
  --max-evals 3 \
  --nthreads 8
```

Explicit QSI folders:

```bash
python scripts/mrtrix_tune.py bayes \
  --qsirecon-dir /path/to/derivatives/qsirecon \
  --qsiprep-dir /path/to/derivatives/qsiprep \
  --subject sub-XXXX \
  --session ses-YY \
  --atlas Brainnetome246Ext \
  --output-dir /path/to/derivatives/opticonn/mrtrix_bayes \
  --run-name bayes_demo \
  --n-iterations 10 \
  --nthreads 8
```

### 2) Config mode (optional)
If you already have a config JSON (e.g., generated by `scripts/mrtrix_discover_bundle.py`), pass it via `--config`:

```bash
python scripts/mrtrix_tune.py sweep \
  --config /path/to/mrtrix_tune_config.json \
  --subject sub-XXXX \
  --atlas Brainnetome246Ext \
  --output-dir /path/to/opticonn/out \
  --n-samples 5
```

## Key parameters
- `--output-dir`: must NOT be inside `qsiprep/` or `qsirecon/` (enforced)
- `--overwrite`: allows overwriting existing theta outputs and passes `-force` to MRtrix tools
- `--dry-run`: prints MRtrix commands without executing or writing outputs
- `--enable-act`: requires an ACT tissue image; discovery must find it (or config must provide it)
- `--enable-sift2`: runs `tcksift2` and feeds weights to `tck2connectome`
- `--emit-config PATH`: in discovery mode, writes the discovered config JSON to disk for provenance
